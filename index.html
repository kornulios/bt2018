<html>

<head>
  <script src="./node_modules/axios/dist/axios.js"></script>
  <script src="js/view.js"></script>
  <script src="js/data.js"></script>
  <script src="js/result.js"></script>
  <script src="js/track.js"></script>
  <script src="js/player.js"></script>
  <script src="js/race.js"></script>
  <script src="js/championship.js"></script>

  <link rel="stylesheet" href="css/style.css">

</head>

<body>
  <script>
    //main game object
    var game;

    document.addEventListener('DOMContentLoaded', function (e) {
      console.log('up and running');

      class Game {
        constructor() {
          this.gameSpeed = 1;      //50 ticks per second
          this.gameTimer;
          this.gameRunning = false;
          this.view = new View();
          this.championship = Object.create(null);
          this.race = Object.create(null);
        }

        createRace(players, track) {
          this.race = new Race(players, track);
          this.view.renderPlayers(this.race);
        }

        createChampionship(players) {
          this.championship = new Championship(players);
        }

        mainScreen() {
          let me = this;
          me.view.renderChampionshipView(me.championship);
        }

        nextRace() {
          let me = this,
            race = me.championship.getNextRace();

          me.view.renderPlayers(race);
          me.view.showRunScreen();
          me.race = new Race(race.players, new Track(trackData[0], 'women')); //temp solution!
        }

        startRace() {
          var me = this;
          // me.gameTimer = setInterval(function () {
          //   if (!me.race.run()) {
          //     clearInterval(me.gameTimer);
          //     me.championship.addResults(me.race.results);
          //     me.view.showFinishScreen();
          //   }
          //   me.view.renderPlayers(me.race);
          //   me.view.renderResults(me.race.results.getWaypointResults(me.race.track.waypoints.length - 1));
          // }, me.gameSpeed);
          let gameRunning = true;
          do
            gameRunning = me.race.run();
          while (gameRunning)

          me.championship.addResults(me.race.results);
          me.view.showFinishScreen();
          me.view.renderPlayers(me.race);
          me.view.renderResults(me.race.results.getWaypointResults(me.race.track.waypoints.length - 1));
        }

        setGameSpeed() {
          debugger
          this.gameSpeed = 10;
        }
      }
      game = new Game();

      getData().then(function (res) {
        game.createChampionship(res.data.players);
        game.view.renderChampionshipView(game.championship);
      }).catch(function (err) {
        console.log('Data load failed', err);
      });

      initEvents();
      // game.view.drawOnCanvas();
    });

    function initEvents() {
      var startButton = document.getElementById('start-btn');
      startButton.addEventListener('click', startGame);
      document.getElementById('run-btn').addEventListener('click', game.startRace.bind(game));
      document.getElementById('finish-btn').addEventListener('click', game.mainScreen.bind(game));
      document.getElementById('speed-fastest').addEventListener('click', game.setGameSpeed.bind(game));
    }

    function startGame() {
      if (game) {
        game.nextRace();
      }
    }

  </script>
  <div class='gray-back'>
    <button id="start-btn">Next race</button>
    <button id="run-btn" class="hidden">Run</button>
    <button id="finish-btn" class="hidden">Finish</button>
    <div id="controls">
      <button>Pause</button>
      <span>Speed: </span>
      <button id="speed-normal" class="btn-ctrl">></button>
      <button id="speed-fast" class="btn-ctrl">>></button>
      <button id="speed-fastest" class="btn-ctrl">>>></button>
    </div>
  </div>
  <div id="track-info"></div>
  <div id="main-view"></div>
  <div id="results-view"></div>
  <!-- <canvas id="main-canvas"></canvas> -->
</body>

</html>